# Audio Echo Generation using Convolution

## Overview
The Audio Echo Generation using Convolution is an embedded signal processing project that implements real-time echo effects on audio signals using convolution techniques. This system runs on an STM32F407G-DISC1 development board with the CS43L22 audio codec, processing WAV files from USB storage to produce high-quality echo effects with adjustable parameters.

## Features
- **Real-Time Audio Processing**: Processes 16-bit stereo WAV files with sampling rates up to 48kHz
- **Configurable Echo Effects**: Adjustable echo delay (up to 1 second) and decay factor (0-100%)
- **Hardware Acceleration**: Uses DMA for efficient I2S audio streaming
- **Interactive Controls**: Play/pause/stop functionality with GPIO buttons
- **Dynamic Parameter Adjustment**: ADC input controls echo decay factor in real-time
- **USB Mass Storage Support**: Reads WAV files directly from USB flash drives

## Hardware Components
- **STM32F407G-DISC1**: Main processing board with ARM Cortex-M4 core
- **CS43L22 Audio Codec**: High-quality 24-bit DAC with headphone/speaker outputs
- **GPIO Buttons**: For play/pause/stop control (PA0) and echo enable/disable (PA2)
- **ADC Potentiometer**: For real-time echo decay adjustment (ADC1 Channel 1)
- **USB OTG Port**: For connecting USB flash drives with WAV files

## Software Dependencies
- **STM32CubeIDE**: For embedded development and debugging
- **STM32CubeF4 HAL**: Hardware abstraction layer for STM32 peripherals
- **FATFS**: Middleware for USB mass storage support
- **ARM CMSIS-DSP**: Optional for optimized signal processing functions

## Repository Structure
```
Audio-Echo-Generation/
├── Core
├──── Inc
     ├──── wav_player.h          # Header for WAV player functions
     ├──── audioI2S.h            # Header for I2S audio interface
     ├──── CS43L22.h             # Header for audio codec
├──── Src
     ├──── main.c                # Main application and system control
     ├──── wav_player.c          # WAV file handling and echo processing
     ├──── audioI2S.c            # I2S audio interface driver
     ├──── CS43L22.c             # Audio codec driver
└── README.md                    # Project documentation
```

## Setup Instructions

### Hardware Setup
1. Connect headphones or speakers to the board's audio output jack
2. Connect a USB flash drive with WAV files to the board's USB OTG port
3. Ensure all jumpers are properly configured for audio operation

## Usage

### Playback Control
- Press button on PA0 to start playback
- Press again to pause/resume
- Hold for 1 second to stop playback

### Echo Control
- Toggle button on PA2 to enable/disable echo effect
- Adjust potentiometer connected to ADC1 to change echo decay factor

### File Selection
- Modify `WAV_FILE` define in `main.c` to change default audio file
- Files must be in standard WAV format (16-bit PCM recommended)

## Implementation Details
The echo effect is generated by convolving the audio signal with an impulse response:

```
h[n] = δ[n] + αδ[n − D]
```

Where:
- **α** is the echo decay factor (controlled by ADC input)
- **D** is the echo delay in samples (48000 samples ≈ 1 second at 48kHz)

### Key Functions
- `applyEcho()`: Implements real-time convolution with circular buffer
- `wavPlayer_process()`: Manages audio buffering and processing states
- `audioI2S_play()`: Handles I2S audio streaming with DMA

## Results
The system successfully produces:
- Clear echo effects with adjustable parameters
- Real-time processing without audible artifacts
- Stable playback of various WAV formats
- Responsive user controls for effect customization

![alt text](image.png)

## References
- Cirrus Logic CS43L22 Datasheet
- STM32F407 Reference Manual
- STM32CubeF4 HAL Documentation
- WAVE File Format Specification
